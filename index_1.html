<!DOCTYPE html>
<html>
<head>
  <title>SMART App</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .patient-info {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #007bff;
    }
    .encounter-info {
      background: #e7f3ff;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #17a2b8;
    }
    .observation {
      border: 1px solid #dee2e6;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SMART on FHIR App</h1>
    <div id="output">Loading...</div>
  </div>

  <script>
    let fhirClient = null;

    console.log("SMART App: Starting FHIR.oauth2.ready()");
    
    FHIR.oauth2.ready().then(client => {
      console.log("SMART App: FHIR client ready", client);
      fhirClient = client;
      
      // Enhanced debugging
      console.log("Full client state:", client.state);
      console.log("Patient context:", client.patient);
      console.log("User context:", client.user);
      console.log("Token info:", client.state.tokenResponse);
      
      // Check token expiry
      const tokenExpiry = client.state.tokenResponse?.expires_in;
      if (tokenExpiry && tokenExpiry < 60) {
        document.getElementById("output").innerHTML = `
          <h2>Token Expiring Soon!</h2>
          <p>Token expires in ${tokenExpiry} seconds</p>
          <p>Please re-launch the app from OpenEMR</p>
        `;
        return;
      }
      
      // Try multiple ways to get patient ID
      let patientId = null;
      
      // Method 1: Direct patient context
      if (client.patient && client.patient.id) {
        patientId = client.patient.id;
        console.log("Found patient ID from client.patient:", patientId);
      }
      
      // Method 2: Check URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const patientParam = urlParams.get('patient');
      if (!patientId && patientParam) {
        patientId = patientParam;
        console.log("Found patient ID from URL parameter:", patientId);
      }
      
      // Method 3: Check if patient context exists in state
      if (!patientId && client.state.tokenResponse) {
        const tokenInfo = client.state.tokenResponse;
        console.log("Checking token response for patient info:", tokenInfo);
        // Sometimes patient ID is in the token response
        if (tokenInfo.patient) {
          patientId = tokenInfo.patient;
          console.log("Found patient ID from token response:", patientId);
        }
      }
      
      if (patientId) {
        console.log("Loading patient with ID:", patientId);
        loadPatientWithEncounter(patientId);
      } else {
        console.log("No patient context found, showing patient selection");
        showPatientSelection();
      }
      
    }).catch(err => {
      console.error("SMART App: Auth error", err);
      document.getElementById("output").innerHTML = `
        <h2>Authentication Failed</h2>
        <p>Error: ${err.message}</p>
        <p>Please launch this app from within OpenEMR</p>
        <button onclick="location.reload()">Retry</button>
      `;
    });

    function showPatientSelection() {
      document.getElementById("output").innerHTML = `
        <h2>Successfully Connected!</h2>
        <p>No automatic patient context detected</p>
        <div style="margin: 20px 0;">
          <button onclick="loadPatientList()">Select Patient Manually</button>
          <button onclick="loadFirstPatient()">Load First Available Patient</button>
        </div>
        <p><strong>User:</strong> ${fhirClient.user?.resourceType || 'Unknown'}</p>
        <p><strong>FHIR Server:</strong> ${fhirClient.state.serverUrl}</p>
        <p><strong>Debug:</strong> Check console for detailed context information</p>
      `;
    }

    function loadFirstPatient() {
      document.getElementById("output").innerHTML = '<p>Finding your patient...</p>';
      
      fhirClient.request("Patient?_count=1").then(bundle => {
        if (bundle.entry && bundle.entry.length > 0) {
          const patient = bundle.entry[0].resource;
          console.log("Loading first patient found:", patient);
          loadPatientWithEncounter(patient.id);
        } else {
          document.getElementById("output").innerHTML = '<p>No patients found in the system</p>';
        }
      }).catch(err => {
        console.error("Error loading first patient:", err);
        document.getElementById("output").innerHTML = `<p>Error: ${err.message}</p>`;
      });
    }

    function loadPatientList() {
      document.getElementById("output").innerHTML = '<p>Loading patient list...</p>';

      fhirClient.request("Patient?_count=5").then(bundle => {
        let html = '<h2>Select a Patient:</h2>';
        if (bundle.entry && bundle.entry.length > 0) {
          bundle.entry.forEach(entry => {
            const patient = entry.resource;
            const name = patient.name?.[0];
            const fullName = name ? `${name.given?.join(" ")} ${name.family}` : "Unnamed";
            const birthDate = patient.birthDate || 'Unknown';
            html += `
              <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                <h3>${fullName}</h3>
                <p>Birth Date: ${birthDate}</p>
                <p>Patient ID: ${patient.id}</p>
                <button onclick="loadPatientWithEncounter('${patient.id}')">Select This Patient</button>
              </div>
            `;
          });
        } else {
          html += '<p>No patients found</p>';
        }
        html += '<div style="margin-top: 20px;"><button onclick="showPatientSelection()">Back</button></div>';
        document.getElementById("output").innerHTML = html;
      }).catch(err => {
        console.error("Error loading patients:", err);
        document.getElementById("output").innerHTML = `
          <h2>Error Loading Patients</h2>
          <p>Error: ${err.message}</p>
          <p>This might be a session timeout. Try re-launching the app.</p>
          <button onclick="location.reload()">Retry</button>
        `;
      });
    }

    function loadPatientWithEncounter(patientId) {
      document.getElementById("output").innerHTML = '<p>Loading patient information...</p>';

      // Load patient basic info
      fhirClient.request(`Patient/${patientId}`).then(patient => {
        displayPatientInfo(patient);
        
        // Load last encounter for this patient
        return fhirClient.request(`Encounter?patient=${patientId}&_sort=-date&_count=1`);
      }).then(encounterBundle => {
        if (encounterBundle.entry && encounterBundle.entry.length > 0) {
          const lastEncounter = encounterBundle.entry[0].resource;
          displayEncounterInfo(lastEncounter);
          
          // Load observations from the last encounter
          return fhirClient.request(`Observation?encounter=${lastEncounter.id}&_sort=date`);
        } else {
          document.getElementById("encounterInfo").innerHTML = '<p>No encounters found for this patient</p>';
          return null;
        }
      }).then(observationBundle => {
        if (observationBundle && observationBundle.entry) {
          displayObservations(observationBundle.entry);
        } else {
          document.getElementById("observationInfo").innerHTML = '<p>No observations found for this encounter</p>';
        }
      }).catch(err => {
        console.error("Error loading patient data:", err);
        document.getElementById("output").innerHTML = `
          <h2>Error Loading Patient Data</h2>
          <p>Error: ${err.message}</p>
          <p>Status: ${err.status}</p>
          ${err.status === 401 ? '<p>Session expired - please re-launch the app from OpenEMR</p>' : ''}
          <button onclick="showPatientSelection()">Try Again</button>
        `;
      });
    }

    function displayPatientInfo(patient) {
      const name = patient.name?.[0];
      const fullName = name ? `${name.given?.join(" ")} ${name.family}` : "Unnamed";
      const age = patient.birthDate ? calculateAge(patient.birthDate) : 'Unknown';
      
      document.getElementById("output").innerHTML = `
        <h2>Patient Information</h2>
        
        <div class="patient-info">
          <h3>Basic Information</h3>
          <p><strong>Name:</strong> ${fullName}</p>
          <p><strong>Age:</strong> ${age}</p>
          <p><strong>Gender:</strong> ${patient.gender || 'Not provided'}</p>
          <p><strong>Birth Date:</strong> ${patient.birthDate || 'Not provided'}</p>
          <p><strong>Patient ID:</strong> ${patient.id}</p>
        </div>

        <div id="encounterInfo"></div>
        <div id="observationInfo"></div>

        <div style="margin-top: 20px;">
          <button onclick="showPatientSelection()">Back to Selection</button>
        </div>
      `;
    }

    function displayEncounterInfo(encounter) {
      const encounterDate = encounter.period?.start ? 
        new Date(encounter.period.start).toLocaleDateString() : 'Unknown date';
      const encounterType = encounter.type?.[0]?.coding?.[0]?.display || 
        encounter.type?.[0]?.text || 'Unknown type';
      const encounterStatus = encounter.status || 'Unknown status';
      
      document.getElementById("encounterInfo").innerHTML = `
        <div class="encounter-info">
          <h3>Last Encounter</h3>
          <p><strong>Date:</strong> ${encounterDate}</p>
          <p><strong>Type:</strong> ${encounterType}</p>
          <p><strong>Status:</strong> ${encounterStatus}</p>
          <p><strong>Encounter ID:</strong> ${encounter.id}</p>
        </div>
      `;
    }

    function displayObservations(observations) {
      let html = '<h3>Observations from Last Encounter</h3>';
      
      if (observations.length > 0) {
        observations.forEach(entry => {
          const obs = entry.resource;
          const display = obs.code?.coding?.[0]?.display || obs.code?.text || 'Unknown Observation';
          const value = obs.valueQuantity ? 
            `${obs.valueQuantity.value} ${obs.valueQuantity.unit || obs.valueQuantity.code}` : 
            obs.valueString || obs.valueCodeableConcept?.text || 'No value recorded';
          const date = obs.effectiveDateTime ? 
            new Date(obs.effectiveDateTime).toLocaleString() : 'Unknown date';
          
          html += `
            <div class="observation">
              <h4>${display}</h4>
              <p><strong>Value:</strong> ${value}</p>
              <p><strong>Date/Time:</strong> ${date}</p>
              <p><strong>Status:</strong> ${obs.status || 'Unknown'}</p>
            </div>
          `;
        });
      } else {
        html += '<p>No observations recorded for this encounter</p>';
      }
      
      document.getElementById("observationInfo").innerHTML = html;
    }

    function calculateAge(birthDate) {
      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age;
    }
  </script>
</body>
</html>
