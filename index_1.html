<!DOCTYPE html>
<html>
<head>
  <title>SMART App</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
    .section { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 6px; border-left: 4px solid #007bff; }
    .encounter { border-left-color: #28a745; }
    .observation { background: white; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; }
    .error { background: #f8d7da; border-left-color: #dc3545; color: #721c24; }
    button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SMART App - Patient Dashboard</h1>
    <div id="output">Loading...</div>
  </div>

  <script>
    console.log("Starting SMART App...");
    
    FHIR.oauth2.ready().then(client => {
      console.log("Connected to FHIR server");
      
      // Just load the first (and only) patient immediately
      loadPranathiTest(client);
      
    }).catch(err => {
      console.error("Connection failed:", err);
      document.getElementById("output").innerHTML = `
        <div class="section error">
          <h2>Connection Failed</h2>
          <p>Please launch from OpenEMR and ensure tokens are configured properly</p>
          <button onclick="location.reload()">Retry</button>
        </div>
      `;
    });

    function loadPranathiTest(client) {
      document.getElementById("output").innerHTML = '<p>Loading Pranathi Test data...</p>';
      
      // Since you only have one patient, search and load automatically
      client.request("Patient?name=Pranathi&_count=1")
        .then(bundle => {
          if (bundle.entry && bundle.entry.length > 0) {
            const patient = bundle.entry[0].resource;
            return loadCompletePatientData(client, patient);
          } else {
            // Fallback: get any patient
            return client.request("Patient?_count=1").then(bundle => {
              if (bundle.entry && bundle.entry.length > 0) {
                return loadCompletePatientData(client, bundle.entry[0].resource);
              } else {
                throw new Error("No patients found");
              }
            });
          }
        })
        .catch(err => {
          console.error("Error:", err);
          document.getElementById("output").innerHTML = `
            <div class="section error">
              <h2>Session Expired</h2>
              <p>Please close this window and re-launch the app from OpenEMR</p>
              <p>Error: ${err.message}</p>
              <button onclick="window.close()">Close Window</button>
            </div>
          `;
        });
    }

    async function loadCompletePatientData(client, patient) {
      try {
        // Display patient info
        displayPatientInfo(patient);
        
        // Get last encounter
        const encounterBundle = await client.request(`Encounter?patient=${patient.id}&_sort=-date&_count=1`);
        
        if (encounterBundle.entry && encounterBundle.entry.length > 0) {
          const encounter = encounterBundle.entry[0].resource;
          displayEncounterInfo(encounter);
          
          // Get observations from that encounter
          const obsBundle = await client.request(`Observation?encounter=${encounter.id}&_sort=date`);
          displayObservations(obsBundle.entry || []);
        } else {
          document.getElementById("encounterInfo").innerHTML = `
            <div class="section encounter">
              <h3>Last Encounter</h3>
              <p>No encounters found for this patient</p>
            </div>
          `;
          document.getElementById("observationInfo").innerHTML = `
            <div class="section">
              <h3>Observations</h3>
              <p>No observations available</p>
            </div>
          `;
        }
        
      } catch (err) {
        console.error("Error loading patient data:", err);
        document.getElementById("output").innerHTML = `
          <div class="section error">
            <h2>Data Loading Failed</h2>
            <p>Error: ${err.message}</p>
            <button onclick="location.reload()">Retry</button>
          </div>
        `;
      }
    }

    function displayPatientInfo(patient) {
      const name = patient.name?.[0];
      const fullName = name ? `${name.given?.join(" ")} ${name.family}` : "Unnamed Patient";
      const age = patient.birthDate ? calculateAge(patient.birthDate) : 'Unknown';
      
      document.getElementById("output").innerHTML = `
        <div class="section">
          <h2>Patient Information</h2>
          <p><strong>Name:</strong> ${fullName}</p>
          <p><strong>Age:</strong> ${age}</p>
          <p><strong>Gender:</strong> ${patient.gender || 'Not specified'}</p>
          <p><strong>Birth Date:</strong> ${patient.birthDate || 'Not provided'}</p>
          <p><strong>Patient ID:</strong> ${patient.id}</p>
        </div>
        
        <div id="encounterInfo">Loading encounter...</div>
        <div id="observationInfo">Loading observations...</div>
      `;
    }

    function displayEncounterInfo(encounter) {
      const date = encounter.period?.start ? 
        new Date(encounter.period.start).toLocaleDateString() : 'Unknown';
      const type = encounter.type?.[0]?.coding?.[0]?.display || 
        encounter.type?.[0]?.text || 'Unknown type';
      
      document.getElementById("encounterInfo").innerHTML = `
        <div class="section encounter">
          <h3>Last Encounter</h3>
          <p><strong>Date:</strong> ${date}</p>
          <p><strong>Type:</strong> ${type}</p>
          <p><strong>Status:</strong> ${encounter.status || 'Unknown'}</p>
          <p><strong>Encounter ID:</strong> ${encounter.id}</p>
        </div>
      `;
    }

    function displayObservations(observations) {
      let html = `
        <div class="section">
          <h3>Observations from Last Encounter</h3>
      `;
      
      if (observations.length > 0) {
        html += `<p>Found ${observations.length} observations:</p>`;
        observations.forEach(entry => {
          const obs = entry.resource;
          const display = obs.code?.coding?.[0]?.display || obs.code?.text || 'Unknown';
          let value = 'No value';
          
          if (obs.valueQuantity) {
            value = `${obs.valueQuantity.value} ${obs.valueQuantity.unit || ''}`;
          } else if (obs.valueString) {
            value = obs.valueString;
          }
          
          const date = obs.effectiveDateTime ? 
            new Date(obs.effectiveDateTime).toLocaleDateString() : 'Unknown';
          
          html += `
            <div class="observation">
              <h4>${display}</h4>
              <p><strong>Value:</strong> ${value}</p>
              <p><strong>Date:</strong> ${date}</p>
            </div>
          `;
        });
      } else {
        html += '<p>No observations found for this encounter</p>';
      }
      
      html += '</div>';
      document.getElementById("observationInfo").innerHTML = html;
    }

    function calculateAge(birthDate) {
      const birth = new Date(birthDate);
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age + ' years';
    }
  </script>
</body>
</html>
