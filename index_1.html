<!DOCTYPE html>
<html>
<head>
  <title>SMART App Debug</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
    .debug { background: #e7f3ff; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; font-family: monospace; font-size: 12px; }
    .error { background: #f8d7da; padding: 15px; margin: 10px 0; border-left: 4px solid #dc3545; }
    .success { background: #d4edda; padding: 15px; margin: 10px 0; border-left: 4px solid #28a745; }
    .warning { background: #fff3cd; padding: 15px; margin: 10px 0; border-left: 4px solid #ffc107; }
    .patient-info { background: #e8f5e8; padding: 15px; margin: 10px 0; border-left: 4px solid #28a745; }
    button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SMART App - Diagnostic Mode</h1>
    <div id="output">Starting diagnostics...</div>
  </div>

  <script>
    console.log("=== SMART App Diagnostic Mode ===");
    
    // Extract patient ID from referrer URL
    function extractPatientFromReferrer() {
      const referrer = document.referrer;
      console.log("Document referrer:", referrer);
      const pidMatch = referrer.match(/set_pid=(\d+)/);
      if (pidMatch) {
        const pid = pidMatch[1];
        console.log("üìç Found patient ID from referrer:", pid);
        return pid;
      }
      return null;
    }

    // Extract patient from launch token
    async function extractPatientFromLaunchToken(client) {
      try {
        // Get the launch token from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const launch = urlParams.get('launch');
        
        if (!launch) {
          throw new Error('No launch token found');
        }
        
        console.log("Trying to extract patient from launch token...");
        
        // Try to use OpenEMR's internal API to decode the launch token
        const baseUrl = client.state.serverUrl.replace('/apis/default/fhir', '');
        const launchUrl = `${baseUrl}/interface/smart/launch-context?launch=${encodeURIComponent(launch)}`;
        
        console.log("Trying launch URL:", launchUrl);
        
        const launchResponse = await fetch(launchUrl, {
          headers: {
            'Authorization': `Bearer ${client.state.tokenResponse.access_token}`,
            'Accept': 'application/json'
          }
        });
        
        console.log("Launch response status:", launchResponse.status);
        
        if (launchResponse.ok) {
          const launchContext = await launchResponse.json();
          console.log("Launch context response:", launchContext);
          if (launchContext.patient) {
            return launchContext.patient;
          }
        }
        
        throw new Error('Could not extract patient from launch token');
      } catch (error) {
        console.error('Launch token extraction failed:', error);
        return null;
      }
    }

    // Display patient info
    function displayPatientInfo(patient, source = "FHIR Context") {
      const patientHtml = `
        <div class="patient-info">
          <h3>üë§ Patient Information (Source: ${source})</h3>
          <p><strong>ID:</strong> ${patient.id}</p>
          <p><strong>Name:</strong> ${patient.name?.[0]?.given?.join(' ')} ${patient.name?.[0]?.family}</p>
          <p><strong>Gender:</strong> ${patient.gender}</p>
          <p><strong>Birth Date:</strong> ${patient.birthDate}</p>
        </div>
      `;
      document.getElementById("testResults").innerHTML = patientHtml + document.getElementById("testResults").innerHTML;
    }
    
    FHIR.oauth2.ready().then(client => {
      console.log("‚úÖ FHIR.oauth2.ready() succeeded");
      
      // Comprehensive debugging
      const debugInfo = {
        hasClient: !!client,
        hasState: !!client.state,
        hasTokenResponse: !!client.state?.tokenResponse,
        serverUrl: client.state?.serverUrl,
        tokenType: client.state?.tokenResponse?.token_type,
        accessToken: client.state?.tokenResponse?.access_token ? "Present" : "Missing",
        scope: client.state?.tokenResponse?.scope,
        expiresIn: client.state?.tokenResponse?.expires_in,
        patientContext: client.patient?.id || "None",
        userContext: client.user?.resourceType || "None",
        referrer: document.referrer
      };
      
      console.log("Debug Info:", debugInfo);
      
      // Check for patient context workaround
      const hasPatientContext = !!(client.patient?.id);
      const extractedPid = extractPatientFromReferrer();
      
      let patientContextHtml = '';
      if (hasPatientContext) {
        patientContextHtml = `<div class="success"><h3>‚úÖ Patient Context Available</h3><p>Patient ID: ${client.patient.id}</p></div>`;
      } else if (extractedPid) {
        patientContextHtml = `<div class="warning"><h3>‚ö†Ô∏è No Patient Context, but Found Patient ID: ${extractedPid}</h3><p>Attempting workaround...</p></div>`;
      } else {
        patientContextHtml = `<div class="error"><h3>‚ùå No Patient Context Available</h3></div>`;
      }
      
      document.getElementById("output").innerHTML = `
        <div class="success">
          <h2>‚úÖ Connection Successful</h2>
          <p>SMART on FHIR client initialized successfully</p>
        </div>
        
        ${patientContextHtml}
        
        <div class="debug">
          <h3>üîç Debug Information</h3>
          <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
        </div>
        
        <div style="margin: 20px 0;">
          <button onclick="testCurrentPatient()">Get Current Patient</button>
          <button onclick="testPatientAccess()">Test Patient Access</button>
          <button onclick="testBasicFhir()">Test Basic FHIR</button>
          <button onclick="testCapabilities()">Test Server Capabilities</button>
        </div>
        
        <div id="testResults"></div>
      `;

      // Try to get patient immediately
      testCurrentPatient();
      
    }).catch(err => {
      console.error("‚ùå FHIR.oauth2.ready() failed:", err);
      document.getElementById("output").innerHTML = `
        <div class="error">
          <h2>‚ùå Connection Failed</h2>
          <p><strong>Error:</strong> ${err.message}</p>
          <p><strong>Type:</strong> ${err.name}</p>
          <pre>${err.stack}</pre>
        </div>
      `;
    });

    // Try to get current patient with all workarounds
    function testCurrentPatient() {
      FHIR.oauth2.ready().then(async client => {
        // First try normal patient context
        if (client.patient?.id) {
          console.log("Using FHIR patient context:", client.patient.id);
          return client.patient.read().then(patient => {
            displayPatientInfo(patient, "FHIR Patient Context");
          });
        }
        
        // NEW: Try to extract from launch token
        console.log("Trying launch token extraction...");
        const patientFromLaunch = await extractPatientFromLaunchToken(client);
        if (patientFromLaunch) {
          console.log("Got patient from launch token:", patientFromLaunch);
          return client.request(`Patient/${patientFromLaunch}`)
            .then(patient => {
              displayPatientInfo(patient, "Extracted from Launch Token");
            });
        }
        
        // Fallback: try to extract from referrer
        const extractedPid = extractPatientFromReferrer();
        if (extractedPid) {
          console.log("Trying workaround with extracted ID:", extractedPid);
          // Try to get patient by ID
          return client.request(`Patient/${extractedPid}`)
            .then(patient => {
              displayPatientInfo(patient, "Extracted from Referrer (Workaround)");
            })
            .catch(() => {
              // Try alternative search
              return client.request(`Patient?identifier=${extractedPid}`)
                .then(result => {
                  if (result.entry && result.entry.length > 0) {
                    const patient = result.entry[0].resource;
                    displayPatientInfo(patient, "Found by Identifier Search");
                  }
                });
            });
        }
        
        throw new Error("No patient context and no workaround available");
        
      }).catch(err => {
        console.error("‚ùå Could not get patient:", err);
        document.getElementById("testResults").innerHTML = `
          <div class="error">
            <h3>‚ùå Patient Access: FAILED</h3>
            <p><strong>Error:</strong> ${err.message}</p>
          </div>
        ` + document.getElementById("testResults").innerHTML;
      });
    }

    function testPatientAccess() {
      document.getElementById("testResults").innerHTML = '<p>üîÑ Testing patient access...</p>';
      
      FHIR.oauth2.ready().then(client => {
        console.log("Testing Patient?_count=1");
        
        return client.request("Patient?_count=1", {
          headers: {
            'Accept': 'application/fhir+json',
            'Cache-Control': 'no-cache'
          }
        });
      }).then(result => {
        console.log("‚úÖ Patient access successful:", result);
        document.getElementById("testResults").innerHTML = `
          <div class="success">
            <h3>‚úÖ Patient Access: SUCCESS</h3>
            <p>Successfully retrieved patient data</p>
            <p><strong>Total patients:</strong> ${result.total || 'Unknown'}</p>
            <p><strong>Returned:</strong> ${result.entry?.length || 0} patients</p>
            <pre>${JSON.stringify(result, null, 2).substring(0, 500)}...</pre>
          </div>
        `;
      }).catch(err => {
        console.error("‚ùå Patient access failed:", err);
        document.getElementById("testResults").innerHTML = `
          <div class="error">
            <h3>‚ùå Patient Access: FAILED</h3>
            <p><strong>Status:</strong> ${err.status}</p>
            <p><strong>Message:</strong> ${err.message}</p>
            <p><strong>URL:</strong> ${err.url || 'Unknown'}</p>
            <pre>${JSON.stringify(err, null, 2)}</pre>
          </div>
        `;
      });
    }

    function testBasicFhir() {
      document.getElementById("testResults").innerHTML = '<p>üîÑ Testing basic FHIR access...</p>';
      
      FHIR.oauth2.ready().then(client => {
        console.log("Testing metadata endpoint");
        return client.request("metadata");
      }).then(result => {
        console.log("‚úÖ Metadata access successful");
        document.getElementById("testResults").innerHTML = `
          <div class="success">
            <h3>‚úÖ Basic FHIR: SUCCESS</h3>
            <p>Server metadata retrieved successfully</p>
            <p><strong>FHIR Version:</strong> ${result.fhirVersion}</p>
            <p><strong>Software:</strong> ${result.software?.name}</p>
          </div>
        `;
      }).catch(err => {
        console.error("‚ùå Metadata access failed:", err);
        document.getElementById("testResults").innerHTML = `
          <div class="error">
            <h3>‚ùå Basic FHIR: FAILED</h3>
            <p><strong>Error:</strong> ${err.message}</p>
          </div>
        `;
      });
    }

    function testCapabilities() {
      document.getElementById("testResults").innerHTML = '<p>üîÑ Testing server capabilities...</p>';
      
      FHIR.oauth2.ready().then(client => {
        // Test what we can actually access
        const tests = [
          { name: "Patient", url: "Patient?_summary=count" },
          { name: "Encounter", url: "Encounter?_summary=count" },
          { name: "Observation", url: "Observation?_summary=count" }
        ];
        
        const testPromises = tests.map(test => 
          client.request(test.url)
            .then(result => ({ ...test, success: true, total: result.total }))
            .catch(err => ({ ...test, success: false, error: err.message }))
        );
        
        return Promise.all(testPromises);
      }).then(results => {
        console.log("‚úÖ Capability tests completed:", results);
        
        let html = '<div class="debug"><h3>üîç Resource Access Test Results</h3>';
        results.forEach(result => {
          if (result.success) {
            html += `<p>‚úÖ ${result.name}: ${result.total || 0} resources</p>`;
          } else {
            html += `<p>‚ùå ${result.name}: ${result.error}</p>`;
          }
        });
        html += '</div>';
        
        document.getElementById("testResults").innerHTML = html;
      }).catch(err => {
        console.error("‚ùå Capability tests failed:", err);
        document.getElementById("testResults").innerHTML = `
          <div class="error">
            <h3>‚ùå Capability Tests: FAILED</h3>
            <p>${err.message}</p>
          </div>
        `;
      });
    }
  </script>
</body>
</html>
