<!DOCTYPE html>
<html>
<head>
  <title>SMART App</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; }
    .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .section { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 6px; border-left: 4px solid #007bff; }
    .encounter-section { border-left-color: #28a745; }
    .observation { background: white; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SMART App</h1>
    <div id="output">Loading...</div>
  </div>

  <script>
    FHIR.oauth2.ready().then(client => {
      console.log("SMART App: Connected with patient context", client.patient?.id);
      
      if (client.patient && client.patient.id) {
        loadPatientData(client.patient.id);
      } else {
        document.getElementById("output").innerHTML = `
          <h2>No Patient Context</h2>
          <p>Please ensure you're launching from a patient's chart in OpenEMR</p>
        `;
      }
    }).catch(err => {
      document.getElementById("output").innerHTML = `
        <h2>Connection Failed</h2>
        <p>Error: ${err.message}</p>
      `;
    });

    function loadPatientData(patientId) {
      // Load patient info
      FHIR.oauth2.ready().then(client => {
        return client.request(`Patient/${patientId}`);
      }).then(patient => {
        displayPatientInfo(patient);
        return FHIR.oauth2.ready().then(client => 
          client.request(`Encounter?patient=${patientId}&_sort=-date&_count=1`)
        );
      }).then(encounterBundle => {
        if (encounterBundle.entry && encounterBundle.entry.length > 0) {
          const encounter = encounterBundle.entry[0].resource;
          displayEncounterInfo(encounter);
          return FHIR.oauth2.ready().then(client =>
            client.request(`Observation?encounter=${encounter.id}&_sort=date`)
          );
        }
        return { entry: [] };
      }).then(obsBundle => {
        displayObservations(obsBundle.entry || []);
      }).catch(err => {
        document.getElementById("output").innerHTML = `<p>Error: ${err.message}</p>`;
      });
    }

    function displayPatientInfo(patient) {
      const name = patient.name?.[0];
      const fullName = name ? `${name.given?.join(" ")} ${name.family}` : "Unnamed";
      const age = patient.birthDate ? calculateAge(patient.birthDate) : 'Unknown';
      
      document.getElementById("output").innerHTML = `
        <h2>Patient Information</h2>
        <div class="section">
          <h3>Patient Details</h3>
          <p><strong>Name:</strong> ${fullName}</p>
          <p><strong>Age:</strong> ${age}</p>
          <p><strong>Gender:</strong> ${patient.gender || 'Not specified'}</p>
          <p><strong>Birth Date:</strong> ${patient.birthDate || 'Not provided'}</p>
        </div>
        <div id="encounterInfo"></div>
        <div id="observationInfo"></div>
      `;
    }

    function displayEncounterInfo(encounter) {
      const date = encounter.period?.start ? new Date(encounter.period.start).toLocaleDateString() : 'Unknown';
      const type = encounter.type?.[0]?.coding?.[0]?.display || 'Unknown type';
      
      document.getElementById("encounterInfo").innerHTML = `
        <div class="section encounter-section">
          <h3>Last Encounter</h3>
          <p><strong>Date:</strong> ${date}</p>
          <p><strong>Type:</strong> ${type}</p>
          <p><strong>Status:</strong> ${encounter.status}</p>
        </div>
      `;
    }

    function displayObservations(observations) {
      let html = '<div class="section"><h3>Observations from Last Encounter</h3>';
      
      if (observations.length > 0) {
        observations.forEach(entry => {
          const obs = entry.resource;
          const display = obs.code?.coding?.[0]?.display || 'Unknown Observation';
          const value = obs.valueQuantity ? 
            `${obs.valueQuantity.value} ${obs.valueQuantity.unit || ''}` : 
            obs.valueString || 'No value';
          const date = obs.effectiveDateTime ? new Date(obs.effectiveDateTime).toLocaleDateString() : 'Unknown';
          
          html += `
            <div class="observation">
              <h4>${display}</h4>
              <p><strong>Value:</strong> ${value}</p>
              <p><strong>Date:</strong> ${date}</p>
            </div>
          `;
        });
      } else {
        html += '<p>No observations found</p>';
      }
      
      html += '</div>';
      document.getElementById("observationInfo").innerHTML = html;
    }

    function calculateAge(birthDate) {
      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age + ' years';
    }
  </script>
</body>
</html>
