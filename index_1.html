<!DOCTYPE html>
<html>
<head>
  <title>SMART App Debug</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
    .debug { background: #e7f3ff; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; font-family: monospace; font-size: 12px; }
    .error { background: #f8d7da; padding: 15px; margin: 10px 0; border-left: 4px solid #dc3545; }
    .success { background: #d4edda; padding: 15px; margin: 10px 0; border-left: 4px solid #28a745; }
    button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SMART App - Diagnostic Mode</h1>
    <div id="output">Starting diagnostics...</div>
  </div>

  <script>
    console.log("=== SMART App Diagnostic Mode ===");
    
    FHIR.oauth2.ready().then(client => {
      console.log("‚úÖ FHIR.oauth2.ready() succeeded");
      
      // Comprehensive debugging
      const debugInfo = {
        hasClient: !!client,
        hasState: !!client.state,
        hasTokenResponse: !!client.state?.tokenResponse,
        serverUrl: client.state?.serverUrl,
        tokenType: client.state?.tokenResponse?.token_type,
        accessToken: client.state?.tokenResponse?.access_token ? "Present" : "Missing",
        scope: client.state?.tokenResponse?.scope,
        expiresIn: client.state?.tokenResponse?.expires_in,
        patientContext: client.patient?.id || "None",
        userContext: client.user?.resourceType || "None"
      };
      
      console.log("Debug Info:", debugInfo);
      
      document.getElementById("output").innerHTML = `
        <div class="success">
          <h2>‚úÖ Connection Successful</h2>
          <p>SMART on FHIR client initialized successfully</p>
        </div>
        
        <div class="debug">
          <h3>üîç Debug Information</h3>
          <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
        </div>
        
        <div style="margin: 20px 0;">
          <button onclick="testPatientAccess()">Test Patient Access</button>
          <button onclick="testBasicFhir()">Test Basic FHIR</button>
          <button onclick="testCapabilities()">Test Server Capabilities</button>
        </div>
        
        <div id="testResults"></div>
      `;
      
    }).catch(err => {
      console.error("‚ùå FHIR.oauth2.ready() failed:", err);
      document.getElementById("output").innerHTML = `
        <div class="error">
          <h2>‚ùå Connection Failed</h2>
          <p><strong>Error:</strong> ${err.message}</p>
          <p><strong>Type:</strong> ${err.name}</p>
          <pre>${err.stack}</pre>
        </div>
      `;
    });

    function testPatientAccess() {
      document.getElementById("testResults").innerHTML = '<p>üîÑ Testing patient access...</p>';
      
      FHIR.oauth2.ready().then(client => {
        console.log("Testing Patient?_count=1");
        
        return client.request("Patient?_count=1", {
          headers: {
            'Accept': 'application/fhir+json',
            'Cache-Control': 'no-cache'
          }
        });
      }).then(result => {
        console.log("‚úÖ Patient access successful:", result);
        document.getElementById("testResults").innerHTML = `
          <div class="success">
            <h3>‚úÖ Patient Access: SUCCESS</h3>
            <p>Successfully retrieved patient data</p>
            <p><strong>Total patients:</strong> ${result.total || 'Unknown'}</p>
            <p><strong>Returned:</strong> ${result.entry?.length || 0} patients</p>
            <pre>${JSON.stringify(result, null, 2).substring(0, 500)}...</pre>
          </div>
        `;
      }).catch(err => {
        console.error("‚ùå Patient access failed:", err);
        document.getElementById("testResults").innerHTML = `
          <div class="error">
            <h3>‚ùå Patient Access: FAILED</h3>
            <p><strong>Status:</strong> ${err.status}</p>
            <p><strong>Message:</strong> ${err.message}</p>
            <p><strong>URL:</strong> ${err.url || 'Unknown'}</p>
            <pre>${JSON.stringify(err, null, 2)}</pre>
          </div>
        `;
      });
    }

    function testBasicFhir() {
      document.getElementById("testResults").innerHTML = '<p>üîÑ Testing basic FHIR access...</p>';
      
      FHIR.oauth2.ready().then(client => {
        console.log("Testing metadata endpoint");
        return client.request("metadata");
      }).then(result => {
        console.log("‚úÖ Metadata access successful");
        document.getElementById("testResults").innerHTML = `
          <div class="success">
            <h3>‚úÖ Basic FHIR: SUCCESS</h3>
            <p>Server metadata retrieved successfully</p>
            <p><strong>FHIR Version:</strong> ${result.fhirVersion}</p>
            <p><strong>Software:</strong> ${result.software?.name}</p>
          </div>
        `;
      }).catch(err => {
        console.error("‚ùå Metadata access failed:", err);
        document.getElementById("testResults").innerHTML = `
          <div class="error">
            <h3>‚ùå Basic FHIR: FAILED</h3>
            <p><strong>Error:</strong> ${err.message}</p>
          </div>
        `;
      });
    }

    function testCapabilities() {
      document.getElementById("testResults").innerHTML = '<p>üîÑ Testing server capabilities...</p>';
      
      FHIR.oauth2.ready().then(client => {
        // Test what we can actually access
        const tests = [
          { name: "Patient", url: "Patient?_summary=count" },
          { name: "Encounter", url: "Encounter?_summary=count" },
          { name: "Observation", url: "Observation?_summary=count" }
        ];
        
        const testPromises = tests.map(test => 
          client.request(test.url)
            .then(result => ({ ...test, success: true, total: result.total }))
            .catch(err => ({ ...test, success: false, error: err.message }))
        );
        
        return Promise.all(testPromises);
      }).then(results => {
        console.log("‚úÖ Capability tests completed:", results);
        
        let html = '<div class="debug"><h3>üîç Resource Access Test Results</h3>';
        results.forEach(result => {
          if (result.success) {
            html += `<p>‚úÖ ${result.name}: ${result.total || 0} resources</p>`;
          } else {
            html += `<p>‚ùå ${result.name}: ${result.error}</p>`;
          }
        });
        html += '</div>';
        
        document.getElementById("testResults").innerHTML = html;
      }).catch(err => {
        console.error("‚ùå Capability tests failed:", err);
        document.getElementById("testResults").innerHTML = `
          <div class="error">
            <h3>‚ùå Capability Tests: FAILED</h3>
            <p>${err.message}</p>
          </div>
        `;
      });
    }
  </script>
</body>
</html>
